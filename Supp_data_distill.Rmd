---
title: "Reproducible supplement"
description: |
  Reproducible supplement to recreate all tables and figures using R for manuscript: "Gauthier J et al. Comparative analysis of safety and efficacy across three CD19 CAR T-cell products in aggressive B-NHL"
author:
  - name: Jordan Gauthier, MD
    affiliation: Fred Hutch, University of Washington
date: "`r Sys.Date()`"
output: 
  distill::distill_article:
    code_folding: true
    toc: true
    toc_float: true
    self_contained: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
library(openxlsx)
library(gtsummary)
library(tidyverse)
library(htmlTable)
library(tidylog)
library(skimr)
theme_set(theme_bw())
# load(file = "envfordistill.RData")
```

### Load wrangled dataset and functions

```{r,warning = FALSE}
df <- read.xlsx("dfs/20220210_df.xlsx",sheet=1)

# Plot calibration curves for ordinal models with 2 intercepts
fit_check_ord2 <- function(fit,predictor){
  par(mfrow=c(1,2))
  plot(rms::calibrate(fit, kint = 1,B=200,group=df$crs_g_r))
  plot(rms::calibrate(fit, kint = 2,B=200,group=df$crs_g_r))
}

# Plot calibration curves for ordinal models with 3 intercepts
fit_check_ord3 <- function(fit,predictor){
  par(mfrow=c(1,3))
  plot(rms::calibrate(fit, kint = 1,B=200,group=df$nt_g_r))
  plot(rms::calibrate(fit, kint = 2,B=200,group=df$nt_g_r))
  plot(rms::calibrate(fit, kint = 3,B=200,group=df$nt_g_r))
}

# Sparser function to extract coefficients and p values from rms fits
get_model_stats = function(x) {
  cap = capture.output(print(x))
  
  #model stats
  stats = c()
  stats$R2.adj = str_match(cap, "R2 adj\\s+ (\\d\\.\\d+)") %>% na.omit() %>% .[, 2] %>% as.numeric()
  
  #coef stats lines
  coef_lines = cap[which(str_detect(cap, "Coef\\s+S\\.E\\.")):(length(cap) - 1)]
  
  #parse
  coef_lines_table = suppressWarnings(readr::read_table(coef_lines %>% stringr::str_c(collapse = "\n")))
  colnames(coef_lines_table)[1] = "Predictor"
  
  list(
    stats = stats,
    coefs = coef_lines_table
  )
}


# Impute missing data
set.seed(12345)
df$preleuka_LDH_l <- log10(df$preleuka_LDH)
df$preleuka_ALC_l <- log10(df$preleuka_ALC)
df <- df %>% 
  mutate(product=fct_relevel(product,"axicel","tisacel","jcar014"))
library(rms)
dd <- datadist(df)
options(datadist='dd')
mi <- aregImpute(formula = ~ product+preleuka_LDH_l+age+hct_score+preleuka_bulk_s+preleuka_ALC_l,
                 data=df, n.impute = 10, burnin=3, nk=3, type='pmm', pmmtype=1)
```

### Table 1. Patient and disease characteristics
```{r table 1,layout="l-body-outset"}
df %>%
  select(`CAR T-cell product`=product,
           Age=age,
           Sex=sex,
         `HCT-CI`=hct_score,
         `Lymphoma histology`=lymph_type,
         `Number of prior therapies`=prior_tx,
         `Relapse pattern`=relapse_pattern,
         `LDH (U/L)`=preleuka_LDH,
         `Largest lesion diameter (cm)`=preleuka_bulk_s,
         `Ann Arbor Stage`=preleuka_annarbor,
         `Extranodal disease`=preleuka_extranodal,
           `ALC (G/L)`=preleuka_ALC,
         `Bridging therapy post-leukapheresis`=bridge,
         ) %>%
  mutate(`CAR T-cell product`=fct_relevel(`CAR T-cell product`,"axicel","tisacel","jcar014")) %>%
  mutate(`CAR T-cell product`=recode_factor(`CAR T-cell product`,`axicel`="axicel",`tisacel`="tisacel",`jcar014`="JCAR014")) %>%
  tbl_summary(
    by = `CAR T-cell product`,
    type = list(all_continuous() ~ "continuous2",
                `HCT-CI` ~ 'continuous2',
                `Number of prior therapies` ~ 'continuous2'),
    statistic = all_continuous() ~ c("{median} ({p25}, {p75})", 
                                     "{min}, {max}"),
    missing_text = "Missing data",
    sort = all_categorical() ~ "frequency") %>%
  add_p(list(all_continuous() ~ "kruskal.test",
             all_categorical() ~ "fisher.test"),
             simulate.p.value=TRUE) %>% 
  bold_labels() 
```

### Table 2. CRS, ICANS and response after CD19 CAR T-cell therapy
```{r,layout="l-body-outset"}
t2a <- df %>%
  mutate(crs_g3 = case_when(crs_g3 == "≥3" ~ 1,
                            crs_g3 == "<3" ~ 0)) %>%
  transmute(
    `CAR T-cell product` = product,
    `Grade ≥1 CRS` = crs_g1_d,
    `Grade ≥2 CRS` = crs_g2_d,
    `Grade ≥3 CRS` = crs_g3,
    `CRS duration (days)` = CRS_duration,
    `Grade ≥1 ICANS` = nt_g1_d,
    `Grade ≥2 ICANS` = nt_g2_d,
    `Grade ≥3 ICANS` = nt_g3_d,
    `ICANS duration (days)` = ICANS_duration,
    `ICANS duration (days)` = ICANS_duration,
    `Tocilizumab` = ifelse(toci_nb==0,"No","Yes"),
    `Corticosteroids` = ifelse(steroids_cum_dex_d==0,"No","Yes")
  ) %>%
  mutate(`CAR T-cell product` = fct_relevel(`CAR T-cell product`, "axicel", "tisacel", "jcar014")) %>%
  mutate(
    `CAR T-cell product` = recode_factor(
      `CAR T-cell product`,
      `axicel` = "axicel",
      `tisacel` = "tisacel",
      `jcar014` = "JCAR014"
    )
  ) %>%
  tbl_summary(
    by = `CAR T-cell product`,
    type = list(`CRS duration (days)` ~ 'continuous2',
                `ICANS duration (days)` ~ 'continuous2'
                # `Tocilizumab (number of administrations)` ~ 'continuous2',
                # `Cumulative corticosteroids dose (mg of dexamethasone)` ~ 'continuous2'
                ),
    statistic = all_continuous() ~ c("{median} ({p25}, {p75})",
                                     "{min}, {max}"),
    missing = "no"
  ) %>%
  add_p(test = list(
        `Grade ≥1 CRS` ~ "fisher.test",
        `Grade ≥2 CRS` ~ "fisher.test",
        `Grade ≥3 CRS` ~ "fisher.test",
        `Grade ≥1 ICANS` ~ "fisher.test",
        `Grade ≥2 ICANS` ~ "fisher.test",
        `Grade ≥3 ICANS` ~ "fisher.test",
        `CRS duration (days)` ~ "kruskal.test",
        `ICANS duration (days)` ~ "kruskal.test",
        `Tocilizumab` ~ "fisher.test",
        `Corticosteroids` ~ "fisher.test"
        ),
        simulate.p.value = TRUE) %>%
  bold_labels()

#### Table 2b response ####
t2b <- df %>%
  filter(!is.na(bestresp_b)) %>%
  transmute(
    `CAR T-cell product` = fct_relevel(product, "axicel", "tisacel", "jcar014"),
    `Overall response rate (best response)` = as.numeric(bestresp_b),
    `Complete response rate (best response)` = bestCR_b
  ) %>%
  mutate(
    `CAR T-cell product` = recode_factor(
      `CAR T-cell product`,
      `axicel` = "axicel",
      `tisacel` = "tisacel",
      `jcar014` = "JCAR014"
    )
  ) %>%
  tbl_summary(
    by = `CAR T-cell product`,
    # type = list(`CRS grade` ~ 'continuous2',
    #             `ICANS grade` ~ 'continuous2'),
    statistic = all_continuous() ~ c("{median} ({p25}, {p75})",
                                     "{min}, {max}"),
    missing = "no"
  ) %>%
  add_p(test = everything() ~ "fisher.test",
        simulate.p.value = TRUE) %>%
  bold_labels() 

#### Stack table 2a and 2b ####
tbl_stack(
  tbls = list(t2a, t2b),group_header = c("Toxicity","Response"))
```

### Table S1. Details of aggressive lymphoma types treated with JCAR014

```{r}
df %>% 
  filter(product=="jcar014") %>% 
  select(`Lymphoma histologies`=lymph_type2) %>% 
  tbl_summary(
    # type = list(`CRS grade` ~ 'continuous2',
    #             `ICANS grade` ~ 'continuous2'),
    statistic = all_continuous() ~ c("{median} ({p25}, {p75})",
                                     "{min}, {max}"),missing_text = "Missing data",
    sort = all_categorical() ~ "frequency")
```

### Table S2. Time from leukapheresis to CAR T-cell infusion

```{r}
df %>% 
  transmute(
    `CAR T-cell product` = product,
    `Time from leukapheresis to CAR T-cell infusion` = as.numeric(veintovein)
  ) %>% 
  mutate(`CAR T-cell product` = fct_relevel(`CAR T-cell product`, "axicel", "tisacel", "jcar014")) %>%
  mutate(
    `CAR T-cell product` = recode_factor(
      `CAR T-cell product`,
      `axicel` = "axicel",
      `tisacel` = "tisacel",
      `jcar014` = "JCAR014"
    )
  ) %>%
  tbl_summary(
    by = `CAR T-cell product`,
    type = `Time from leukapheresis to CAR T-cell infusion` ~ 'continuous2',
    statistic = all_continuous() ~ c("{median} ({p25}, {p75})",
                                     "{min}, {max}"),
    missing_text = "Missing data"
  ) %>%
  add_p(test = everything() ~ "kruskal.test",
        simulate.p.value = TRUE) %>%
  bold_labels()
```

### Table S3. Rates of severe infections and cytopenia after CD19 CAR T-cell therapy

```{r}
df %>% 
  select(
    `CAR T-cell product` = product,
    `Grade ≥3 infection` = day30_sinf,
    `Grade ≥3 neutropenia` = day30G34neutropenia,
    `Grade ≥3 thrombocytopenia` = day30G34thrombocytopenia,
    `Grade ≥3 anemia` = day30G34anemia
  ) %>% 
  mutate(`CAR T-cell product` = fct_relevel(`CAR T-cell product`, "axicel", "tisacel", "jcar014")) %>%
  mutate(
    `CAR T-cell product` = recode_factor(
      `CAR T-cell product`,
      `axicel` = "axicel",
      `tisacel` = "tisacel",
      `jcar014` = "JCAR014"
    )
  ) %>%
  tbl_summary(
    by = `CAR T-cell product`,
    # type = list(`CRS duration (days)` ~ 'continuous2',
    #             `ICANS duration (days)` ~ 'continuous2'
    #             # `Tocilizumab (number of administrations)` ~ 'continuous2',
    #             # `Cumulative corticosteroids dose (mg of dexamethasone)` ~ 'continuous2'
    #             ),
    statistic = all_continuous() ~ c("{median} ({p25}, {p75})",
                                     "{min}, {max}"),
    missing_text = "Missing data"
  ) %>%
  add_p(test = everything() ~ "fisher.test",
         simulate.p.value = TRUE) %>%
  bold_labels()
```

### Figure 3. CRS and ICANS rates across products

```{r,layout="l-body-outset",fig.width=11, fig.height=6}
library(patchwork)
df <- df %>% 
  mutate(
    product_m = case_when(
      product== "axicel" ~ "axicel",
      product=="tisacel" ~ "tisacel/JCAR014",
      product=="jcar014" ~ "tisacel/JCAR014"
    )
  )
theme_set(theme_bw())
#### CRS rates by product ####
CRS_p <- df %>% 
  mutate(crs_g=as.character(crs_g),
         product=fct_relevel(product,"axicel","tisacel","jcar014")) %>% 
  mutate(product=recode(product,"jcar014"="JCAR014")) %>% 
  group_by(product) %>%
  count(crs_g) %>% 
  mutate(perc = round((n / sum(n)) * 100, 1), labs = paste0(perc, "%")) %>% 
  ggplot(aes(product, perc, group = product)) +
  geom_col(aes(fill = crs_g))+
  geom_text(
  aes(label = labs),
  position = position_stack(vjust = 0.5),
  col = "white",
  size = 4
) +
  scale_fill_manual(
    name = "CRS grade",
    values = c("#fc9272", "#fb6a4a", "#ef3b2c", "#cb181d", "#99000d")
  ) +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    legend.title = element_text(size = 12),
    legend.position = "right",
    legend.text = element_text(size = 10),
    axis.text.x = element_text(size = 18, color = "black")
  ) +
  scale_y_continuous(name = "Percentage")


#### ICANS rates by product ####
ICANS_p <- df %>% 
  mutate(nt_g=as.character(nt_g),
         product=fct_relevel(product,"axicel","tisacel","jcar014")) %>% 
  mutate(product=recode(product,"jcar014"="JCAR014")) %>% 
  group_by(product) %>%
  count(nt_g) %>%
  mutate(perc = round((n / sum(n)) * 100, 1), labs = paste0(perc, "%")) %>%
  ggplot(aes(product, perc, group = product)) +
  geom_col(aes(fill = nt_g)) +
  geom_text(
    aes(label = labs),
    position = position_stack(vjust = 0.5),
    col = "white",
    size = 4
  ) +
  scale_fill_manual(
    name = "ICANS grade",
    values = c("#66c2a4", "#41ae76", "#238b45", "#006d2c", "#00441b")
  ) +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    legend.title = element_text(size = 12),
    legend.position = "right",
    legend.text = element_text(size = 10),
    axis.text.x = element_text(size = 18, color = "black")
  ) +
  scale_y_continuous(name = "Percentage")

fig1 <- CRS_p + ICANS_p
fig1 + plot_annotation(
  title = 'Figure 2.',
  tag_levels = "A",
  theme = theme(plot.title = element_text(face='bold'))
) &
  theme(plot.tag = element_text(face = 'bold'))

# Save to eps
# cairo_ps("Manuscript/Fig3.eps", width = 12, height = 7)
# fig1 + plot_annotation(
#   title = 'Figure 3.',
#   tag_levels = "A",
#   theme = theme(plot.title = element_text(size = 24,face='bold'))
# ) &
#   theme(plot.tag = element_text(size=22,face = 'bold'))
# dev.off()
```

### Univariate ordinal logistic regression model for CRS grade

```{r fituniCRS, layout="l-body-outset"}
fit_crs <- lrm(crs_g_r ~ product,x=T,y=T,data=df)
options(prType="html")
print(
  fit_crs,
  labels = c("tisacel", "JCAR014"),
  digits = 2,
  coefs = T,
  title = "Univariate ordinal proportional odds logistic regression model for CRS grade"
)
options(prType=NULL)
```

### Multivariable ordinal logistic regression model for CRS grade

```{r fitmultiCRS,layout="l-body-outset",results='asis',fig.width=10, fig.height=6}
fit_mi <-
  fit.mult.impute(
    crs_g_r ~ product + preleuka_LDH_l + preleuka_bulk_s + age + hct_score + preleuka_ALC_l,
    fitter = lrm,
    data = df,
    xtrans = mi,
    x = T,
    y = T
  )
options(prType="html")
print(
  fit_mi,
  labels = c("tisacel", "JCAR014"),
  digits = 2,
  coefs = T
)
print(summary(fit_mi,age=c(50,60)),digits = 2)
print(anova(fit_mi),digits = 2)
plot(anova(fit_mi))
fit_check_ord2(fit_mi)
options(prType=NULL)

#Sparse ORs and 95% CIs from univariate model
crs_d <- data.frame(summary(fit_crs))
crs_unadj <- rbind(
  cbind(round(crs_d[2,4],2),paste(round(crs_d[2,6],2),round(crs_d[2,7],2),sep="-")),
  cbind(round(crs_d[4,4],2),paste(round(crs_d[4,6],2),round(crs_d[4,7],2),sep="-"))
)
colnames(crs_unadj) <- c("unadjusted OR","95% CI")
rownames(crs_unadj) <- c("Tisacel versus axicel","JCAR014 versus axicel")

#Parse p values from univariate model
crs_unadjstats_d <- get_model_stats(fit_crs)

#Parse p values from multivariable model
crs_adjstats_d <- get_model_stats(fit_mi)

#Parse ORs and 95% CI from multivariable model
d <- data.frame(summary(fit_mi))
crs_adj <- rbind(
  cbind(round(d[12,4],2),paste(round(d[12,6],2),round(d[12,7],2),sep = "-")),
  cbind(round(d[14,4],2),paste(round(d[14,6],2),round(d[14,7],2),sep = "-"))
)
colnames(crs_adj) <- c("adjusted OR","95% CI")
rownames(crs_adj) <- c("Tisacel versus axicel","JCAR014 versus axicel")

### Create object to merge tables later
CRS_t <-
  cbind(crs_unadj,
        crs_unadjstats_d$coefs[3:4, 5],
        crs_adj,
        crs_adjstats_d$coefs[3:4, 5])
```

### Sensitivity analysis: Fit multivariable model for CRS including bridging

```{r fitmultiCRS_bridge,layout="l-body-outset"}
fit_mi <-
  fit.mult.impute(
    crs_g_r ~ product + preleuka_LDH_l + preleuka_bulk_s + age + hct_score + preleuka_ALC_l + bridge,
    fitter = lrm,
    data = df,
    xtrans = mi,
    x = T,
    y = T
  )
options(prType="html")
print(
  fit_mi,
  labels = c("tisacel", "JCAR014"),
  digits = 2,
  coefs = T,
  title = "Multivariable ordinal proportional odds logistic regression model for CRS grade"
)
options(prType=NULL)

#Sparse ORs and 95% CIs from univariate model
crs_d <- data.frame(summary(fit_crs))
crs_unadj <- rbind(
  cbind(round(crs_d[2,4],2),paste(round(crs_d[2,6],2),round(crs_d[2,7],2),sep="-")),
  cbind(round(crs_d[4,4],2),paste(round(crs_d[4,6],2),round(crs_d[4,7],2),sep="-"))
)
colnames(crs_unadj) <- c("unadjusted OR","95% CI")
rownames(crs_unadj) <- c("Tisacel versus axicel","JCAR014 versus axicel")

#Parse p values from univariate model
crs_unadjstats_d <- get_model_stats(fit_crs)

#Parse p values from multivariable model
crs_adjstats_d <- get_model_stats(fit_mi)

#Parse ORs and 95% CI from multivariable model
d <- data.frame(summary(fit_mi))
crs_adj <- rbind(
  cbind(round(d[12,4],2),paste(round(d[12,6],2),round(d[12,7],2),sep = "-")),
  cbind(round(d[14,4],2),paste(round(d[14,6],2),round(d[14,7],2),sep = "-"))
)
colnames(crs_adj) <- c("adjusted OR","95% CI")
rownames(crs_adj) <- c("Tisacel versus axicel","JCAR014 versus axicel")

### Create object to merge tables later
CRS_bridge_t <-
  cbind(crs_unadj,
        crs_unadjstats_d$coefs[3:4, 5],
        crs_adj,
        crs_adjstats_d$coefs[3:4, 5])

```

### Univariate ordinal logistic regression model for ICANS grade

```{r fitunivICANS, layout="l-body-outset"}
fit_nt <- lrm(nt_g_r ~ product,x=T,y=T,data=df)
options(prType="html")
print(
  fit_nt,
  digits = 2,
  coefs = T
)
options(prType=NULL)
```

### Multivariable proportional odds logistic regression model for ICANS grade

```{r fitmultiICANS, layout="l-body-outset",results='asis',fig.width=12, fig.height=5}
fit_mi <-
  fit.mult.impute(
    nt_g_r ~ product + preleuka_LDH_l + preleuka_bulk_s + age + hct_score + preleuka_ALC_l,
    fitter = lrm,
    data = df,
    xtrans = mi,
    x=T,
    y=T
  )
options(prType="html")
print(
  fit_mi,
  digits = 2,
  coefs = T,
  title = "Multivariable ordinal proportional odds logistic regression model for ICANS grade"
)
print(summary(fit_mi,age=c(50,60)),digits = 2)
print(anova(fit_mi),digits = 2)
plot(anova(fit_mi))
fit_check_ord3(fit_mi)
options(prType=NULL)

#Parse ORs and 95%CI from univariate model
d <- summary(fit_nt)
d <- data.frame(d)
nt_unadj <- rbind(
  cbind(round(d[2,4],2),paste(round(d[2,6],2),round(d[2,7],2),sep="-")),
  cbind(round(d[4,4],2),paste(round(d[4,6],2),round(d[4,7],2),sep="-"))
)
colnames(nt_unadj) <- c("unadjusted OR","95% CI")
rownames(nt_unadj) <- c("Tisacel versus axicel","JCAR014 versus axicel")

#Parse p values from univariate model
unadjstats_d <- get_model_stats(fit_nt)

#Parse p values from multivariable model
adjstats_d <- get_model_stats(fit_mi)

#Parse ORs and 95% CI from multivariable model
d <- data.frame(summary(fit_mi))
nt_adj <- rbind(
  cbind(round(d[12,4],2),paste(round(d[12,6],2),round(d[12,7],2),sep="-")),
  cbind(round(d[14,4],2),paste(round(d[14,6],2),round(d[14,7],2),sep="-"))
)
colnames(nt_adj) <- c("adjusted OR","95% CI")
rownames(nt_adj) <- c("Tisacel versus axicel","JCAR014 versus axicel")

#Create object to merge later
NT_t <-
  cbind(nt_unadj,
        round(unadjstats_d$coefs[4:5, 5], 4),
        nt_adj,
        round(adjstats_d$coefs[4:5, 5], 4))
```

### Sensitivity analysis: fit multivariable model for ICANS including bridging therapy

```{r fitmultiICANS_bridge, layout="l-body-outset"}
fit_mi <-
  fit.mult.impute(
    nt_g_r ~ product + preleuka_LDH_l + preleuka_bulk_s + age + hct_score + preleuka_ALC_l + bridge,
    fitter = lrm,
    data = df,
    xtrans = mi,
    x=T,
    y=T
  )
options(prType="html")
print(
  fit_mi,
  digits = 2,
  coefs = T
)
options(prType=NULL)
d <- summary(fit_nt)
d <- data.frame(d)

#Parse ORs and 95%CI from univariate model
nt_unadj <- rbind(
  cbind(round(d[2,4],2),paste(round(d[2,6],2),round(d[2,7],2),sep="-")),
  cbind(round(d[4,4],2),paste(round(d[4,6],2),round(d[4,7],2),sep="-"))
)
colnames(nt_unadj) <- c("unadjusted OR","95% CI")
rownames(nt_unadj) <- c("Tisacel versus axicel","JCAR014 versus axicel")

#Parse p values from univariate model
unadjstats_d <- get_model_stats(fit_nt)

#Parse p values from multivariable model
adjstats_d <- get_model_stats(fit_mi)

#Parse ORs and 95% CI from multivariable model
d <- data.frame(summary(fit_mi))
nt_adj <- rbind(
  cbind(round(d[12,4],2),paste(round(d[12,6],2),round(d[12,7],2),sep="-")),
  cbind(round(d[14,4],2),paste(round(d[14,6],2),round(d[14,7],2),sep="-"))
)
colnames(nt_adj) <- c("adjusted OR","95% CI")
rownames(nt_adj) <- c("Tisacel versus axicel","JCAR014 versus axicel")

#Create object to merge later
NT_bridge_t <-
  cbind(nt_unadj,
        round(unadjstats_d$coefs[4:5, 5], 4),
        nt_adj,
        round(adjstats_d$coefs[4:5, 5], 4))
```

### Univariate logistic regression model for CR (best response)

```{r firunivCR}
fit_resp <- lrm(bestCR_b ~ product,x=T,y=T,data=df)
options(prType="html")
print(
  fit_resp,
  digits = 2,
  coefs = T
)
options(prType=NULL)
```

### Multivariable logistic regression model for CR (best response)

```{r fitmultiCR,results='asis',layout="l-body-outset",fig.width=5, fig.height=5}
fit_mi <-
  fit.mult.impute(
    bestCR_b ~ product + preleuka_LDH_l + preleuka_bulk_s + age + hct_score + preleuka_ALC_l,
    fitter = lrm,
    data = df,
    xtrans = mi,
    x=T,
    y=T
  )
options(prType="html")
print(
  fit_mi,
  digits = 2,
  coefs = T,
  title = "Multivariable ordinal proportional odds logistic regression model for CR (best response)"
)
print(summary(fit_mi,age=c(50,60),preleuka_LDH_l=c(2,2.3),preleuka_bulk_s=c(1,2),preleuka_ALC_l=c(2,2.3)),digits = 2)
print(anova(fit_mi),digits = 2)
plot(anova(fit_mi))
plot(calibrate(fit_mi))
options(prType=NULL)

#Parse ORs and 95% CIs from univariate model
d <- summary(fit_resp)
d <- data.frame(d)
resp_unadj <- rbind(
  cbind(round(d[2,4],2),paste(round(d[2,6],2),round(d[2,7],2),sep="-")),
  cbind(round(d[4,4],2),paste(round(d[4,6],2),round(d[4,7],2),sep="-"))
)
colnames(resp_unadj) <- c("unadjusted OR","95% CI")
rownames(resp_unadj) <- c("Tisacel versus axicel","JCAR014 versus axicel")

#Parse p values from univariate model
unadjstats_d <- get_model_stats(fit_resp)

#Parse p values from multivariable model
adjstats_d <- get_model_stats(fit_mi)

#Parse ORs and 95% CI from multivariable model
d <- data.frame(summary(fit_mi))
resp_adj <- rbind(
  cbind(round(d[12,4],2),paste(round(d[12,6],2),round(d[12,7],2),sep="-")),
  cbind(round(d[14,4],2),paste(round(d[14,6],2),round(d[14,7],2),sep="-"))
)
colnames(resp_adj) <- c("adjusted OR","95% CI")
rownames(resp_adj) <- c("Tisacel versus axicel","JCAR014 versus axicel")

#Create object to merge later
CR_t <- cbind(resp_unadj,unadjstats_d$coefs[2:3,5],resp_adj,adjstats_d$coefs[2:3,5])
```

### Table 3. CAR T-cell product type and outcome prediction

```{r t3}
rbind(CRS_t, NT_t, CR_t) %>%
  addHtmlTableStyle(pos.caption = "bottom") %>%
  htmlTable(
    rgroup = c("CRS grade*", "ICANS grade*", "CR (Best Response)^"),
    n.rgroup = c(2, 2, 2),
    caption = "*From a multivariable proportional odds logistic regression model or ^logistic regression model including the following variables: CAR T-cell product type, preleukapheresis LDH, preleukapheresis largest lesion diameter, age, HCT-CI, preleukapheresis ALC. P values per the Wald test."
  )
```

### Table S4. Sensitivity analysis including bridging therapy in addition to the minimal adjustment set of covariates

```{r tS4}
fit_mi <-
  fit.mult.impute(
    bestCR_b ~ product + preleuka_LDH_l + preleuka_bulk_s + age + hct_score + preleuka_ALC_l + bridge,
    fitter = lrm,
    data = df,
    xtrans = mi,
    x=T,
    y=T
  )
options(prType="html")
print(
  fit_mi,
  digits = 2,
  coefs = T
)
options(prType=NULL)
#Parse ORs and 95% CIs from univariate model
d <- summary(fit_resp)
str(d)
d <- data.frame(d)
resp_unadj <- rbind(
  cbind(round(d[2,4],2),paste(round(d[2,6],2),round(d[2,7],2),sep="-")),
  cbind(round(d[4,4],2),paste(round(d[4,6],2),round(d[4,7],2),sep="-"))
)
colnames(resp_unadj) <- c("unadjusted OR","95% CI")
rownames(resp_unadj) <- c("Tisacel versus axicel","JCAR014 versus axicel")

#Parse p values from univariate model
unadjstats_d <- get_model_stats(fit_resp)

#Parse p values from multivariable model
adjstats_d <- get_model_stats(fit_mi)

#Parse ORs and 95% CI from multivariable model
d <- data.frame(summary(fit_mi))
resp_adj <- rbind(
  cbind(round(d[12,4],2),paste(round(d[12,6],2),round(d[12,7],2),sep="-")),
  cbind(round(d[14,4],2),paste(round(d[14,6],2),round(d[14,7],2),sep="-"))
)
colnames(resp_adj) <- c("adjusted OR","95% CI")
rownames(resp_adj) <- c("Tisacel versus axicel","JCAR014 versus axicel")

CR_bridge_t <- cbind(resp_unadj,unadjstats_d$coefs[2:3,5],resp_adj,adjstats_d$coefs[2:3,5])

#Build final table
rbind(CRS_bridge_t, NT_bridge_t, CR_bridge_t) %>%
  addHtmlTableStyle(pos.caption = "bottom") %>%
  htmlTable(
    rgroup = c("CRS grade*", "ICANS grade*", "CR (Best Response)^"),
    n.rgroup = c(2, 2, 2),
    caption = "*From a multivariable proportional odds logistic regression model or ^logistic regression model including the following variables: CAR T-cell product type, preleukapheresis LDH, preleukapheresis largest lesion diameter, age, HCT-CI, preleukapheresis ALC, bridging therapy post leukapheresis. P values per the Wald test."
  )
```

### Multivariable ordinal logistic regression model for CRS grade including interaction effects

```{r effmodCRS,results='asis',layout="l-body-outset",fig.width=8, fig.height=6}
#Merge tisacel and JCAR014
df <- df %>% 
  mutate(product_s=ifelse(product=="axicel","axicel","tisacel/JCAR014"))
dd <- datadist(df)
options(datadist='dd')

#### Refit model for CRS with interaction terms
fit_mi <-
  fit.mult.impute(
    crs_g_r ~ product_s*preleuka_LDH_l + product_s*preleuka_bulk_s + product_s*age + product_s*hct_score + product_s*preleuka_ALC_l,
    fitter = lrm,
    data = df,
    xtrans = mi,
    x=T,
    y=T
  )
options(prType="html")
print(
  fit_mi,
  digits = 2,
  coefs = T
)
print(anova(fit_mi))
plot(anova(fit_mi))
fit_check_ord2(fit_mi)
options(prType=NULL)
```

### Multivariable ordinal logistic regression model for ICANS grade including interaction terms

```{r effmodICANS,results='asis',fig.width=12, fig.height=6}
fit_mi <-
  fit.mult.impute(
    nt_g_r ~ product_s*preleuka_LDH_l + product_s*preleuka_bulk_s + product_s*age + product_s*hct_score + product_s*preleuka_ALC_l,
    fitter = lrm,
    data = df,
    xtrans = mi,
    x=TRUE,y=TRUE
  )
options(prType="html")
print(
  fit_mi,
  digits = 2,
  coefs = T
)
print(anova(fit_mi))
plot(anova(fit_mi))
fit_check_ord3(fit_mi)
options(prType=NULL)
```

## Multivariable logistic regression model for CR including interaction terms

```{r effmodCR,layout="l-body-outset",fig.width=8, fig.height=8}
fit_mi <-
  fit.mult.impute(
    bestCR_b ~ product_s * preleuka_ALC_l + product_s * preleuka_bulk_s + product_s *
      age + product_s * hct_score + product_s * preleuka_LDH_l,
    fitter = lrm,
    data = df,
    xtrans = mi,
    x=T,y=T
  )
options(prType="html")
print(
  fit_mi,
  digits = 2,
  coefs = T
)
# options(prType=NULL)
print(anova(fit_mi))
plot(anova(fit_mi))
plot(calibrate(fit_mi))
options(prType=NULL)
```

## Figure 4. The efficacy of distinct CAR T-cell products is differentially impacted by preleukapheresis ALC

```{r,layout="l-body-outset",fig.width=10, fig.height=8}
alc_breaks <- round(c(10^-.5,10^-.25,10^0,10^.25),2)
data.frame(Predict(fit_mi,preleuka_ALC_l,product_s,fun = plogis)) %>%
  mutate(product_s=recode(product_s,`axicel`="axicel",`tisacel/jcar014`="tisacel/JCAR014")) %>% 
  ggplot() +
  geom_line(aes(x=preleuka_ALC_l,y=yhat,col=product_s)) +
  geom_ribbon(aes(x=preleuka_ALC_l,ymin=lower, ymax=upper,fill=product_s),alpha=0.10)+
  labs(x = "Preleukapheresis ALC (G/L)",
       y = "Probability of CR")+
  scale_x_continuous(labels = alc_breaks,breaks = c(-.5,-.25,0,.25))+
  ggtitle("Figure 4.")+
  theme_bw() +
  theme(title = element_text(size=16,face="bold"),legend.title=element_blank())

# Save to eps
# cairo_ps("Manuscript/Fig 4.eps", width = 9, height = 8)
# data.frame(Predict(fit_mi,preleuka_ALC_l,product_s,fun = plogis)) %>%
#   mutate(product_s=recode(product_s,`axicel`="axicel",`tisacel/jcar014`="tisacel/JCAR014")) %>% 
#   ggplot() +
#   geom_line(aes(x=preleuka_ALC_l,y=yhat,col=product_s)) +
#   geom_ribbon(aes(x=preleuka_ALC_l,ymin=lower, ymax=upper,fill=product_s),alpha=0.10)+
#   labs(x = "Preleukapheresis ALC (G/L)",
#        y = "Probability of CR")+
#   scale_x_continuous(labels = alc_breaks,breaks = c(-.5,-.25,0,.25))+
#   ggtitle("Figure 4.")+
#   theme_bw() +
#   theme(plot.title = element_text(size=16,face="bold"),legend.title=element_blank())
# dev.off()

```

## Computational environment

```{r}
devtools::session_info()
```

