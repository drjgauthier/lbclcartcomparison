---
title: "Reproducible supplement"
description: |
  Reproducible supplement to recreate all tables and figures using R for manuscript: "Gauthier J et al. Impact of CD19 CAR T-cell product type on outcomes in relapsed or refractory aggressive B-NHL"
author:
  - name: Jordan Gauthier, MD
    affiliation: Fred Hutch, University of Washington
date: "`r Sys.Date()`"
output: 
  distill::distill_article:
    code_folding: true
    toc: true
    toc_float: true
    self_contained: false
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
library(openxlsx)
library(gtsummary)
library(tidyverse)
library(htmlTable)
library(skimr)
library(patchwork)
library(ggpubr)
library(ormPlot)
library(rms)
library(grid)
library(gridExtra)
theme_set(theme_bw())
```

### Load wrangled dataset and define key functions

```{r,warning = FALSE}
df <- read.xlsx("dfs/20220331_df.xlsx",sheet=1)

# Plot calibration curves for ordinal models with 2 intercepts
fit_check_ord2 <- function(fit,predictor){
  par(mfrow=c(1,2))
  plot(rms::calibrate(fit, kint = 1,B=200,group=df$crs_g_r))
  plot(rms::calibrate(fit, kint = 2,B=200,group=df$crs_g_r))
}

# Plot calibration curves for ordinal models with 3 intercepts
fit_check_ord3 <- function(fit,predictor){
  par(mfrow=c(1,3))
  plot(rms::calibrate(fit, kint = 1,B=200,group=df$nt_g_r))
  plot(rms::calibrate(fit, kint = 2,B=200,group=df$nt_g_r))
  plot(rms::calibrate(fit, kint = 3,B=200,group=df$nt_g_r))
}

# Sparser function to extract coefficients and p values from rms fits
get_model_stats = function(x) {
  cap = capture.output(print(x))
  
  #model stats
  stats = c()
  stats$R2.adj = str_match(cap, "R2 adj\\s+ (\\d\\.\\d+)") %>% na.omit() %>% .[, 2] %>% as.numeric()
  
  #coef stats lines
  coef_lines = cap[which(str_detect(cap, "Coef\\s+S\\.E\\.")):(length(cap) - 1)]
  
  #parse
  coef_lines_table = suppressWarnings(readr::read_table(coef_lines %>% stringr::str_c(collapse = "\n")))
  colnames(coef_lines_table)[1] = "Predictor"
  
  list(
    stats = stats,
    coefs = coef_lines_table
  )
}

# Sparse regression coefficients, CI and P values from univariate and multivariable fits (minimal adjustment set of covariates) for response
resp_table_sparser <- function(fituni,fitmulti){
#Parse ORs and 95% CIs from univariate model
d <- summary(fituni)
d <- data.frame(d)
resp_unadj <- rbind(
  cbind(round(d[2,4],2),paste(round(d[2,6],2),round(d[2,7],2),sep="-")),
  cbind(round(d[4,4],2),paste(round(d[4,6],2),round(d[4,7],2),sep="-"))
)
colnames(resp_unadj) <- c("unadjusted OR","95% CI")
rownames(resp_unadj) <- c("Tisacel versus axicel","JCAR014 versus axicel")
#Parse p values from univariate model
unadjstats_d <- get_model_stats(fituni)
#Parse ORs and 95% CI from multivariable model
d <- data.frame(summary(fitmulti))
resp_adj <- rbind(
  cbind(round(d[12,4],2),paste(round(d[12,6],2),round(d[12,7],2),sep="-")),
  cbind(round(d[14,4],2),paste(round(d[14,6],2),round(d[14,7],2),sep="-"))
)
colnames(resp_adj) <- c("adjusted OR","95% CI")
rownames(resp_adj) <- c("Tisacel versus axicel","JCAR014 versus axicel")
#Parse p values from multivariable model
adjstats_d <- get_model_stats(fitmulti)
#Create table object to merge later
resp_t <- cbind(resp_unadj,unadjstats_d$coefs[2:3,5],resp_adj,adjstats_d$coefs[2:3,5])
resp_t
}


# Impute missing data
set.seed(12345)
df$preleuka_LDH_l <- log10(df$preleuka_LDH)
df$preleuka_ALC_l <- log10(df$preleuka_ALC)
df$preLD_LDH_l <- log10(df$preLD_LDH)
df$preLD_ALC_l <- log10(df$preLD_ALC)

df <- df %>% 
  mutate(product=fct_relevel(product,"axicel","tisacel","jcar014"))
dd <- datadist(df)
options(datadist='dd')
mi <- aregImpute(formula = ~ product+preleuka_LDH_l+age+hct_score+preleuka_bulk_s+preleuka_ALC_l,
                 data=df, n.impute = 10, burnin=3, nk=3, type='pmm', pmmtype=1)

# Impute missing data excluding JCAR014 patient
set.seed(12346)
df2 <- df[df$product!="jcar014",]
df2$product <- as.factor(as.character(df2$product))
df2 <- df2 %>% 
  select(
    product,
    preleuka_LDH_l,
    age,
    hct_score,
    preleuka_bulk_s,
    preleuka_ALC_l,
    crs_g_r,
    nt_g_r,
    bestCR_b,
    bestCR_CT_b,
    bestCR_PET_b
  )
dd2 <- datadist(df2)
options(datadist='dd2')
mi2 <- aregImpute(formula = ~ product+preleuka_LDH_l+age+hct_score+preleuka_bulk_s+preleuka_ALC_l,
                 data=df2, n.impute = 10, burnin=3, nk=3, type='pmm', pmmtype=1)

```

### Table 1. Patient and disease characteristics
```{r table 1,layout="l-body-outset"}
df %>%
  select(`CAR T-cell product`=product,
           Age=age,
           Sex=sex,
         `HCT-CI`=hct_score,
         `Lymphoma histology`=lymph_type,
         `Number of prior therapies`=prior_tx,
         `Relapse pattern`=relapse_pattern,
         `LDH (U/L)`=preleuka_LDH,
         `Largest lesion diameter (cm)`=preleuka_bulk_s,
         `Ann Arbor Stage`=preleuka_annarbor,
         `Extranodal disease`=preleuka_extranodal,
           `ALC (G/L)`=preleuka_ALC,
         `Bridging therapy post-leukapheresis`=bridge,
         ) %>%
  mutate(`CAR T-cell product`=fct_relevel(`CAR T-cell product`,"axicel","tisacel","jcar014")) %>%
  mutate(`CAR T-cell product`=recode_factor(`CAR T-cell product`,`axicel`="axicel",`tisacel`="tisacel",`jcar014`="JCAR014")) %>%
  tbl_summary(
    by = `CAR T-cell product`,
    type = list(all_continuous() ~ "continuous2",
                `HCT-CI` ~ 'continuous2',
                `Number of prior therapies` ~ 'continuous2'),
    statistic = all_continuous() ~ c("{median} ({p25}, {p75})", 
                                     "{min}, {max}"),
    missing_text = "Missing data",
    sort = all_categorical() ~ "frequency") %>%
  add_p(list(all_continuous() ~ "kruskal.test",
             all_categorical() ~ "fisher.test"),
             simulate.p.value=TRUE) %>% 
  bold_labels() 
```

### Table 2. CRS, ICANS and response after CD19 CAR T-cell therapy
```{r,layout="l-body-outset"}
t2a <- df %>%
  mutate(crs_g3 = case_when(crs_g3 == "≥3" ~ 1,
                            crs_g3 == "<3" ~ 0)) %>%
  transmute(
    `CAR T-cell product` = product,
    `Grade ≥1 CRS` = crs_g1_d,
    `Grade ≥2 CRS` = crs_g2_d,
    `Grade ≥3 CRS` = crs_g3,
    `CRS duration (days)` = CRS_duration,
    `Grade ≥1 ICANS` = nt_g1_d,
    `Grade ≥2 ICANS` = nt_g2_d,
    `Grade ≥3 ICANS` = nt_g3_d,
    `ICANS duration (days)` = ICANS_duration,
    `ICANS duration (days)` = ICANS_duration,
    `Tocilizumab` = ifelse(toci_nb==0,"No","Yes"),
    `Corticosteroids` = ifelse(steroids_cum_dex_d==0,"No","Yes")
  ) %>%
  mutate(`CAR T-cell product` = fct_relevel(`CAR T-cell product`, "axicel", "tisacel", "jcar014")) %>%
  mutate(
    `CAR T-cell product` = recode_factor(
      `CAR T-cell product`,
      `axicel` = "axicel",
      `tisacel` = "tisacel",
      `jcar014` = "JCAR014"
    )
  ) %>%
  tbl_summary(
    by = `CAR T-cell product`,
    type = list(`CRS duration (days)` ~ 'continuous2',
                `ICANS duration (days)` ~ 'continuous2'
                # `Tocilizumab (number of administrations)` ~ 'continuous2',
                # `Cumulative corticosteroids dose (mg of dexamethasone)` ~ 'continuous2'
                ),
    statistic = all_continuous() ~ c("{median} ({p25}, {p75})",
                                     "{min}, {max}"),
    missing = "no"
  ) %>%
  add_p(test = list(
        `Grade ≥1 CRS` ~ "fisher.test",
        `Grade ≥2 CRS` ~ "fisher.test",
        `Grade ≥3 CRS` ~ "fisher.test",
        `Grade ≥1 ICANS` ~ "fisher.test",
        `Grade ≥2 ICANS` ~ "fisher.test",
        `Grade ≥3 ICANS` ~ "fisher.test",
        `CRS duration (days)` ~ "kruskal.test",
        `ICANS duration (days)` ~ "kruskal.test",
        `Tocilizumab` ~ "fisher.test",
        `Corticosteroids` ~ "fisher.test"
        ),
        simulate.p.value = TRUE) %>%
  bold_labels()

#### Table 2b response ####
t2b <- df %>%
  filter(!is.na(bestresp_b)) %>% # to use the right denominator for percentage calculation (pts available for response)
  transmute(
    `CAR T-cell product` = fct_relevel(product, "axicel", "tisacel", "jcar014"),
    `Overall response rate (best response)` = as.numeric(bestresp_b),
    `Overall response rate (best response - CT-only criteria)` = as.numeric(bestresp_CT_b),
    `Overall response rate (best response - PET-only criteria)` = as.numeric(bestresp_PET_b),
    `Complete response rate (best response)` = bestCR_b,
    `Complete response rate (best response - CT-only criteria)` = as.numeric(bestCR_CT_b),
    `Complete response rate (best response - PET-only criteria)` = as.numeric(bestCR_PET_b)
  ) %>%
  mutate(
    `CAR T-cell product` = recode_factor(
      `CAR T-cell product`,
      `axicel` = "axicel",
      `tisacel` = "tisacel",
      `jcar014` = "JCAR014"
    )
  ) %>%
  tbl_summary(
    by = `CAR T-cell product`,
    # type = list(`CRS grade` ~ 'continuous2',
    #             `ICANS grade` ~ 'continuous2'),
    statistic = all_continuous() ~ c("{median} ({p25}, {p75})",
                                     "{min}, {max}"),
    missing = "no"
  ) %>%
  add_p(test = everything() ~ "fisher.test",
        simulate.p.value = TRUE) %>%
  bold_labels() 

#### Stack table 2a and 2b ####
tbl_stack(
  tbls = list(t2a, t2b),group_header = c("Toxicity","Response"))
```

### Table S1. Details of aggressive lymphoma types treated with JCAR014

```{r}
df %>% 
  filter(product=="jcar014") %>% 
  select(`Lymphoma histologies`=lymph_type2) %>% 
  tbl_summary(
    # type = list(`CRS grade` ~ 'continuous2',
    #             `ICANS grade` ~ 'continuous2'),
    statistic = all_continuous() ~ c("{median} ({p25}, {p75})",
                                     "{min}, {max}"),missing_text = "Missing data",
    sort = all_categorical() ~ "frequency")
```

### Table S2. Time from leukapheresis to CAR T-cell infusion

```{r}
df %>% 
  transmute(
    `CAR T-cell product` = product,
    `Time from leukapheresis to CAR T-cell infusion` = as.numeric(veintovein)
  ) %>% 
  mutate(`CAR T-cell product` = fct_relevel(`CAR T-cell product`, "axicel", "tisacel", "jcar014")) %>%
  mutate(
    `CAR T-cell product` = recode_factor(
      `CAR T-cell product`,
      `axicel` = "axicel",
      `tisacel` = "tisacel",
      `jcar014` = "JCAR014"
    )
  ) %>%
  tbl_summary(
    by = `CAR T-cell product`,
    type = `Time from leukapheresis to CAR T-cell infusion` ~ 'continuous2',
    statistic = all_continuous() ~ c("{median} ({p25}, {p75})",
                                     "{min}, {max}"),
    missing_text = "Missing data"
  ) %>%
  add_p(test = everything() ~ "kruskal.test",
        simulate.p.value = TRUE) %>%
  bold_labels()
```

### Table S3. Rates of severe infections and cytopenia after CD19 CAR T-cell therapy

```{r}
df %>% 
  select(
    `CAR T-cell product` = product,
    `Grade ≥3 infection` = day30_sinf,
    `Grade ≥3 neutropenia` = day30G34neutropenia,
    `Grade ≥3 thrombocytopenia` = day30G34thrombocytopenia,
    `Grade ≥3 anemia` = day30G34anemia
  ) %>% 
  mutate(`CAR T-cell product` = fct_relevel(`CAR T-cell product`, "axicel", "tisacel", "jcar014")) %>%
  mutate(
    `CAR T-cell product` = recode_factor(
      `CAR T-cell product`,
      `axicel` = "axicel",
      `tisacel` = "tisacel",
      `jcar014` = "JCAR014"
    )
  ) %>%
  tbl_summary(
    by = `CAR T-cell product`,
    # type = list(`CRS duration (days)` ~ 'continuous2',
    #             `ICANS duration (days)` ~ 'continuous2'
    #             # `Tocilizumab (number of administrations)` ~ 'continuous2',
    #             # `Cumulative corticosteroids dose (mg of dexamethasone)` ~ 'continuous2'
    #             ),
    statistic = all_continuous() ~ c("{median} ({p25}, {p75})",
                                     "{min}, {max}"),
    missing_text = "Missing data"
  ) %>%
  add_p(test = everything() ~ "fisher.test",
         simulate.p.value = TRUE) %>%
  bold_labels()
```

### Figure 2. CRS and ICANS rates across products

```{r,layout="l-body-outset",fig.width=11, fig.height=6}
df <- df %>% 
  mutate(
    product_m = case_when(
      product== "axicel" ~ "axicel",
      product=="tisacel" ~ "tisacel/JCAR014",
      product=="jcar014" ~ "tisacel/JCAR014"
    )
  )
theme_set(theme_bw())
#### CRS rates by product ####
CRS_p <- df %>% 
  mutate(crs_g=as.character(crs_g),
         product=fct_relevel(product,"axicel","tisacel","jcar014")) %>% 
  mutate(product=recode(product,"jcar014"="JCAR014")) %>% 
  group_by(product) %>%
  count(crs_g) %>% 
  mutate(perc = round((n / sum(n)) * 100, 1), labs = paste0(perc, "%")) %>% 
  ggplot(aes(product, perc, group = product)) +
  geom_col(aes(fill = crs_g))+
  geom_text(
  aes(label = labs),
  position = position_stack(vjust = 0.5),
  col = "white",
  size = 4
) +
  scale_fill_manual(
    name = "CRS grade",
    values = c("#fc9272", "#fb6a4a", "#ef3b2c", "#cb181d", "#99000d")
  ) +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    legend.title = element_text(size = 12),
    legend.position = "right",
    legend.text = element_text(size = 10),
    axis.text.x = element_text(size = 18, color = "black")
  ) +
  scale_y_continuous(name = "Percentage")


#### ICANS rates by product ####
ICANS_p <- df %>% 
  mutate(nt_g=as.character(nt_g),
         product=fct_relevel(product,"axicel","tisacel","jcar014")) %>% 
  mutate(product=recode(product,"jcar014"="JCAR014")) %>% 
  group_by(product) %>%
  count(nt_g) %>%
  mutate(perc = round((n / sum(n)) * 100, 1), labs = paste0(perc, "%")) %>%
  ggplot(aes(product, perc, group = product)) +
  geom_col(aes(fill = nt_g)) +
  geom_text(
    aes(label = labs),
    position = position_stack(vjust = 0.5),
    col = "white",
    size = 4
  ) +
  scale_fill_manual(
    name = "ICANS grade",
    values = c("#66c2a4", "#41ae76", "#238b45", "#006d2c", "#00441b")
  ) +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    legend.title = element_text(size = 12),
    legend.position = "right",
    legend.text = element_text(size = 10),
    axis.text.x = element_text(size = 18, color = "black")
  ) +
  scale_y_continuous(name = "Percentage")

fig1 <- CRS_p + ICANS_p
fig1 + plot_annotation(
  title = 'Figure 2.',
  tag_levels = "A",
  theme = theme(plot.title = element_text(face='bold'))
) &
  theme(plot.tag = element_text(face = 'bold'))

# Save to eps
# cairo_ps("Manuscript/Blood_resub2/Fig2.eps", width = 12, height = 7)
# fig1 + plot_annotation(
#   title = 'Figure 2.',
#   tag_levels = "A",
#   theme = theme(plot.title = element_text(size = 24,face='bold'))
# ) &
#   theme(plot.tag = element_text(size=22,face = 'bold'))
# dev.off()
```

### Univariate and multivariable ordinal logistic regression model for CRS grade

```{r fitmultiCRS,layout="l-body-outset",results='asis',fig.width=10, fig.height=6}
options(datadist='dd')
#Univariate
fit_crs <- lrm(crs_g_r ~ product,x=T,y=T,data=df)
options(prType="html")
print(
  fit_crs,
  labels = c("tisacel", "JCAR014"),
  digits = 2,
  coefs = T,
  title = "Univariate ordinal proportional odds logistic regression model for CRS grade"
)
#Multivariable
fit_mi <-
  fit.mult.impute(
    crs_g_r ~ product + preleuka_LDH_l + preleuka_bulk_s + age + hct_score + preleuka_ALC_l,
    fitter = lrm,
    data = df,
    xtrans = mi,
    x = T,
    y = T
  )
print(
  fit_mi,
  labels = c("tisacel", "JCAR014"),
  digits = 2,
  coefs = T
)
forestplot(summary(fit_mi),digits=2,title="OR for CRS grade")
print(summary(fit_mi,age=c(50,60)),digits = 2)
print(anova(fit_mi),digits = 2)
plot(anova(fit_mi))
fit_check_ord2(fit_mi)
options(prType=NULL)

#Sparse ORs and 95% CIs from univariate model
crs_d <- data.frame(summary(fit_crs))
crs_unadj <- rbind(
  cbind(round(crs_d[2,4],2),paste(round(crs_d[2,6],2),round(crs_d[2,7],2),sep="-")),
  cbind(round(crs_d[4,4],2),paste(round(crs_d[4,6],2),round(crs_d[4,7],2),sep="-"))
)
colnames(crs_unadj) <- c("unadjusted OR","95% CI")
rownames(crs_unadj) <- c("Tisacel versus axicel","JCAR014 versus axicel")

#Parse p values from univariate model
crs_unadjstats_d <- get_model_stats(fit_crs)

#Parse ORs and 95% CI from multivariable model
d <- data.frame(summary(fit_mi))
crs_adj <- rbind(
  cbind(round(d[12,4],2),paste(round(d[12,6],2),round(d[12,7],2),sep = "-")),
  cbind(round(d[14,4],2),paste(round(d[14,6],2),round(d[14,7],2),sep = "-"))
)
colnames(crs_adj) <- c("adjusted OR","95% CI")
rownames(crs_adj) <- c("Tisacel versus axicel","JCAR014 versus axicel")

#Parse p values from multivariable model
crs_adjstats_d <- get_model_stats(fit_mi)

### Create object to merge tables later
CRS_t <-
  cbind(crs_unadj,
        crs_unadjstats_d$coefs[3:4, 5],
        crs_adj,
        crs_adjstats_d$coefs[3:4, 5])

```

### Sensitivity analysis: univariate and multivariable ordinal logistic regression model for CRS grade excluding JCAR014 patients

```{r,layout="l-body-outset",results='asis',fig.width=10, fig.height=6}
options(datadist='dd2')
#Univariate
fit_crs_sub <- lrm(crs_g_r ~ product,x=T,y=T,data=df2)
options(prType="html")
print(
  fit_crs,
  labels = c("tisacel", "JCAR014"),
  digits = 2,
  coefs = T,
  title = "Univariate ordinal proportional odds logistic regression model for CRS grade"
)
#Multivariate
fit_mi_sub <-
  fit.mult.impute(
    crs_g_r ~ product + preleuka_LDH_l + preleuka_bulk_s + age + hct_score + preleuka_ALC_l,
    fitter = lrm,
    data = df2,
    xtrans = mi2,
    x = T,
    y = T
  )
print(
  fit_mi_sub,
  digits = 2,
  coefs = T
)
print(summary(fit_mi_sub,age=c(50,60)),digits = 2)
print(anova(fit_mi_sub),digits = 2)
plot(anova(fit_mi_sub))
# fit_check_ord2(fit_mi_sub)
options(prType=NULL)

#Sparse ORs and 95% CIs from univariate model
crs_d <- data.frame(summary(fit_crs_sub))
crs_unadj <- cbind(round(crs_d[2,4],2),paste(round(crs_d[2,6],2),round(crs_d[2,7],2),sep="-"))
colnames(crs_unadj) <- c("unadjusted OR","95% CI")
rownames(crs_unadj) <- c("Tisacel versus axicel")

#Parse p values from univariate model
crs_unadjstats_d <- get_model_stats(fit_crs_sub)

#Parse p values from multivariable model
crs_adjstats_d <- get_model_stats(fit_mi_sub)

#Parse ORs and 95% CI from multivariable model
d <- data.frame(summary(fit_mi_sub))
crs_adj <- cbind(round(d[12,4],2),paste(round(d[12,6],2),round(d[12,7],2),sep = "-"))
colnames(crs_adj) <- c("adjusted OR","95% CI")
rownames(crs_adj) <- c("Tisacel versus axicel")

### Create object to merge tables later
CRS_sub_t <-
  cbind(crs_unadj,
        crs_unadjstats_d$coefs[3, 5],
        crs_adj,
        crs_adjstats_d$coefs[3, 5])
```

### Sensitivity analysis: multivariable ordinal logistic regression model for CRS including bridging

```{r fitmultiCRS_bridge,layout="l-body-outset"}
options(datadist='dd')
fit_mi <-
  fit.mult.impute(
    crs_g_r ~ product + preleuka_LDH_l + preleuka_bulk_s + age + hct_score + preleuka_ALC_l + bridge,
    fitter = lrm,
    data = df,
    xtrans = mi,
    x = T,
    y = T
  )
options(prType="html")
print(
  fit_mi,
  labels = c("tisacel", "JCAR014"),
  digits = 2,
  coefs = T,
  title = "Multivariable ordinal proportional odds logistic regression model for CRS grade"
)
options(prType=NULL)

#Sparse ORs and 95% CIs from univariate model
crs_d <- data.frame(summary(fit_crs))
crs_unadj <- rbind(
  cbind(round(crs_d[2,4],2),paste(round(crs_d[2,6],2),round(crs_d[2,7],2),sep="-")),
  cbind(round(crs_d[4,4],2),paste(round(crs_d[4,6],2),round(crs_d[4,7],2),sep="-"))
)
colnames(crs_unadj) <- c("unadjusted OR","95% CI")
rownames(crs_unadj) <- c("Tisacel versus axicel","JCAR014 versus axicel")

#Parse p values from univariate model
crs_unadjstats_d <- get_model_stats(fit_crs)

#Parse p values from multivariable model
crs_adjstats_d <- get_model_stats(fit_mi)

#Parse ORs and 95% CI from multivariable model
d <- data.frame(summary(fit_mi))
crs_adj <- rbind(
  cbind(round(d[12,4],2),paste(round(d[12,6],2),round(d[12,7],2),sep = "-")),
  cbind(round(d[14,4],2),paste(round(d[14,6],2),round(d[14,7],2),sep = "-"))
)
colnames(crs_adj) <- c("adjusted OR","95% CI")
rownames(crs_adj) <- c("Tisacel versus axicel","JCAR014 versus axicel")

### Create object to merge tables later
CRS_bridge_t <-
  cbind(crs_unadj,
        crs_unadjstats_d$coefs[3:4, 5],
        crs_adj,
        crs_adjstats_d$coefs[3:4, 5])

```

### Sensitivity analysis: multivariable ordinal logistic regression model for CRS including preLD ALC instead of preleukapheresis ALC

```{r,layout="l-body-outset"}
options(datadist='dd')
fit_mi <-
  fit.mult.impute(
    crs_g_r ~ product + preleuka_LDH_l + preleuka_bulk_s + age + hct_score + preLD_ALC_l + bridge,
    fitter = lrm,
    data = df,
    xtrans = mi,
    x = T,
    y = T
  )
options(prType="html")
print(
  fit_mi,
  labels = c("tisacel", "JCAR014"),
  digits = 2,
  coefs = T,
  title = "Multivariable ordinal proportional odds logistic regression model for CRS grade"
)
options(prType=NULL)

#Sparse ORs and 95% CIs from univariate model
crs_d <- data.frame(summary(fit_crs))
crs_unadj <- rbind(
  cbind(round(crs_d[2,4],2),paste(round(crs_d[2,6],2),round(crs_d[2,7],2),sep="-")),
  cbind(round(crs_d[4,4],2),paste(round(crs_d[4,6],2),round(crs_d[4,7],2),sep="-"))
)
colnames(crs_unadj) <- c("unadjusted OR","95% CI")
rownames(crs_unadj) <- c("Tisacel versus axicel","JCAR014 versus axicel")

#Parse p values from univariate model
crs_unadjstats_d <- get_model_stats(fit_crs)

#Parse p values from multivariable model
crs_adjstats_d <- get_model_stats(fit_mi)

#Parse ORs and 95% CI from multivariable model
d <- data.frame(summary(fit_mi))
crs_adj <- rbind(
  cbind(round(d[12,4],2),paste(round(d[12,6],2),round(d[12,7],2),sep = "-")),
  cbind(round(d[14,4],2),paste(round(d[14,6],2),round(d[14,7],2),sep = "-"))
)
colnames(crs_adj) <- c("adjusted OR","95% CI")
rownames(crs_adj) <- c("Tisacel versus axicel","JCAR014 versus axicel")

### Create object to merge tables later
CRS_preLDALC_t <-
  cbind(crs_unadj,
        crs_unadjstats_d$coefs[3:4, 5],
        crs_adj,
        crs_adjstats_d$coefs[3:4, 5])
```


### Univariate and multivariable proportional odds logistic regression model for ICANS grade

```{r, layout="l-body-outset",results='asis',fig.width=12, fig.height=5}
options(datadist='dd')
#Univariate
fit_nt <- lrm(nt_g_r ~ product,x=T,y=T,data=df)
options(prType="html")
print(
  fit_nt,
  digits = 2,
  coefs = T
)
#Multivariable
fit_mi <-
  fit.mult.impute(
    nt_g_r ~ product + preleuka_LDH_l + preleuka_bulk_s + age + hct_score + preleuka_ALC_l,
    fitter = lrm,
    data = df,
    xtrans = mi,
    x=T,
    y=T
  )
print(
  fit_mi, 
  digits = 2,
  coefs = T,
  title = "Multivariable ordinal proportional odds logistic regression model for ICANS grade"
)
forestplot(summary(fit_mi),digits=2,title="OR for ICANS grade")
print(summary(fit_mi,age=c(50,60)),digits = 2)
print(anova(fit_mi),digits = 2)
plot(anova(fit_mi))
fit_check_ord3(fit_mi)
options(prType=NULL)

#Parse ORs and 95%CI from univariate model
d <- summary(fit_nt)
d <- data.frame(d)
nt_unadj <- rbind(
  cbind(round(d[2,4],2),paste(round(d[2,6],2),round(d[2,7],2),sep="-")),
  cbind(round(d[4,4],2),paste(round(d[4,6],2),round(d[4,7],2),sep="-"))
)
colnames(nt_unadj) <- c("unadjusted OR","95% CI")
rownames(nt_unadj) <- c("Tisacel versus axicel","JCAR014 versus axicel")

#Parse p values from univariate model
unadjstats_d <- get_model_stats(fit_nt)

#Parse p values from multivariable model
adjstats_d <- get_model_stats(fit_mi)

#Parse ORs and 95% CI from multivariable model
d <- data.frame(summary(fit_mi))
nt_adj <- rbind(
  cbind(round(d[12,4],2),paste(round(d[12,6],2),round(d[12,7],2),sep="-")),
  cbind(round(d[14,4],2),paste(round(d[14,6],2),round(d[14,7],2),sep="-"))
)
colnames(nt_adj) <- c("adjusted OR","95% CI")
rownames(nt_adj) <- c("Tisacel versus axicel","JCAR014 versus axicel")

#Create object to merge later
NT_t <-
  cbind(nt_unadj,
        round(unadjstats_d$coefs[4:5, 5], 4),
        nt_adj,
        round(adjstats_d$coefs[4:5, 5], 4))
```

### Sensitivity analysis: univariate and multivariable proportional odds logistic regression model for ICANS grade excluding JCAR014 patients

```{r, layout="l-body-outset",results='asis',fig.width=12, fig.height=5}
options(datadist='dd2')
#Univariate
fit_nt_sub <- lrm(nt_g_r ~ product,x=T,y=T,data=df2)
options(prType="html")
print(
  fit_nt_sub,
  digits = 2,
  coefs = T
)
#Multivariate
fit_mi_sub <-
  fit.mult.impute(
    nt_g_r ~ product + preleuka_LDH_l + preleuka_bulk_s + age + hct_score + preleuka_ALC_l,
    fitter = lrm,
    data = df2,
    xtrans = mi2,
    x=T,
    y=T
  )
print(
  fit_mi_sub,
  digits = 2,
  coefs = T,
  title = "Multivariable ordinal proportional odds logistic regression model for ICANS grade"
)
print(summary(fit_mi_sub,age=c(50,60)),digits = 2)
print(anova(fit_mi_sub),digits = 2)
plot(anova(fit_mi_sub))
options(prType=NULL)

#Parse ORs and 95%CI from univariate model
d <- summary(fit_nt_sub)
d <- data.frame(d)
nt_unadj <- cbind(round(d[2,4],2),paste(round(d[2,6],2),round(d[2,7],2),sep="-"))
colnames(nt_unadj) <- c("unadjusted OR","95% CI")
rownames(nt_unadj) <- c("Tisacel versus axicel")

#Parse p values from univariate model
unadjstats_d <- get_model_stats(fit_nt_sub)

#Parse p values from multivariable model
adjstats_d <- get_model_stats(fit_mi_sub)

#Parse ORs and 95% CI from multivariable model
d <- data.frame(summary(fit_mi_sub))
nt_adj <- cbind(round(d[12,4],2),paste(round(d[12,6],2),round(d[12,7],2),sep="-"))
colnames(nt_adj) <- c("adjusted OR","95% CI")
rownames(nt_adj) <- c("Tisacel versus axicel")

#Create object to merge later
NT_sub_t <-
  cbind(nt_unadj,
        round(unadjstats_d$coefs[4, 5], 4),
        nt_adj,
        round(adjstats_d$coefs[4, 5], 4))
```

### Sensitivity analysis: fit multivariable model for ICANS including bridging therapy

```{r fitmultiICANS_bridge, layout="l-body-outset"}
options(datadist='dd')
fit_mi <-
  fit.mult.impute(
    nt_g_r ~ product + preleuka_LDH_l + preleuka_bulk_s + age + hct_score + preleuka_ALC_l + bridge,
    fitter = lrm,
    data = df,
    xtrans = mi,
    x=T,
    y=T
  )
options(prType="html")
print(
  fit_mi,
  digits = 2,
  coefs = T
)
options(prType=NULL)
d <- summary(fit_nt)
d <- data.frame(d)

#Parse ORs and 95%CI from univariate model
nt_unadj <- rbind(
  cbind(round(d[2,4],2),paste(round(d[2,6],2),round(d[2,7],2),sep="-")),
  cbind(round(d[4,4],2),paste(round(d[4,6],2),round(d[4,7],2),sep="-"))
)
colnames(nt_unadj) <- c("unadjusted OR","95% CI")
rownames(nt_unadj) <- c("Tisacel versus axicel","JCAR014 versus axicel")

#Parse p values from univariate model
unadjstats_d <- get_model_stats(fit_nt)

#Parse p values from multivariable model
adjstats_d <- get_model_stats(fit_mi)

#Parse ORs and 95% CI from multivariable model
d <- data.frame(summary(fit_mi))
nt_adj <- rbind(
  cbind(round(d[12,4],2),paste(round(d[12,6],2),round(d[12,7],2),sep="-")),
  cbind(round(d[14,4],2),paste(round(d[14,6],2),round(d[14,7],2),sep="-"))
)
colnames(nt_adj) <- c("adjusted OR","95% CI")
rownames(nt_adj) <- c("Tisacel versus axicel","JCAR014 versus axicel")

#Create object to merge later
NT_bridge_t <-
  cbind(nt_unadj,
        round(unadjstats_d$coefs[4:5, 5], 4),
        nt_adj,
        round(adjstats_d$coefs[4:5, 5], 4))
```

### Sensitivity analysis: fit multivariable model for ICANS including preLD ALC instead of preleukapheresis ALC

```{r, layout="l-body-outset"}
options(datadist='dd')
fit_mi <-
  fit.mult.impute(
    nt_g_r ~ product + preleuka_LDH_l + preleuka_bulk_s + age + hct_score + preLD_ALC_l + bridge,
    fitter = lrm,
    data = df,
    xtrans = mi,
    x=T,
    y=T
  )
options(prType="html")
print(
  fit_mi,
  digits = 2,
  coefs = T
)
options(prType=NULL)
d <- summary(fit_nt)
d <- data.frame(d)

#Parse ORs and 95%CI from univariate model
nt_unadj <- rbind(
  cbind(round(d[2,4],2),paste(round(d[2,6],2),round(d[2,7],2),sep="-")),
  cbind(round(d[4,4],2),paste(round(d[4,6],2),round(d[4,7],2),sep="-"))
)
colnames(nt_unadj) <- c("unadjusted OR","95% CI")
rownames(nt_unadj) <- c("Tisacel versus axicel","JCAR014 versus axicel")

#Parse p values from univariate model
unadjstats_d <- get_model_stats(fit_nt)

#Parse p values from multivariable model
adjstats_d <- get_model_stats(fit_mi)

#Parse ORs and 95% CI from multivariable model
d <- data.frame(summary(fit_mi))
nt_adj <- rbind(
  cbind(round(d[12,4],2),paste(round(d[12,6],2),round(d[12,7],2),sep="-")),
  cbind(round(d[14,4],2),paste(round(d[14,6],2),round(d[14,7],2),sep="-"))
)
colnames(nt_adj) <- c("adjusted OR","95% CI")
rownames(nt_adj) <- c("Tisacel versus axicel","JCAR014 versus axicel")

#Create object to merge later
NT_preLDALC_t <-
  cbind(nt_unadj,
        round(unadjstats_d$coefs[4:5, 5], 4),
        nt_adj,
        round(adjstats_d$coefs[4:5, 5], 4))
```

### Univariate and multivariable logistic regression model for CR (best response by PET or CT)

```{r,results='asis',layout="l-body-outset",fig.width=5, fig.height=5}
options(datadist='dd')
#Univariate
fit_uni <- lrm(bestCR_b ~ product,x=T,y=T,data=df)
options(prType="html")
print(
  fit_uni,
  digits = 2,
  coefs = T
)
fit_uniCT <- lrm(bestCR_CT_b ~ product,x=T,y=T,data=df)
fit_uniPET <- lrm(bestCR_PET_b ~ product,x=T,y=T,data=df)

#Multivariate
fit_mi <-
  fit.mult.impute(
    bestCR_b ~ product + preleuka_LDH_l + preleuka_bulk_s + age + hct_score + preleuka_ALC_l,
    fitter = lrm,
    data = df,
    xtrans = mi,
    x=T,
    y=T
  )
options(prType="html")
print(
  fit_mi,
  digits = 2,
  coefs = T,
  title = "Multivariable ordinal proportional odds logistic regression for CR (best response)"
)
print(summary(fit_mi),digits = 2)
print(anova(fit_mi),digits = 2)
plot(anova(fit_mi))
plot(calibrate(fit_mi))
options(prType=NULL)

#Response by CT only criteria
fit_mi_CT <-
  fit.mult.impute(
    bestCR_CT_b ~ product + preleuka_LDH_l + preleuka_bulk_s + age + hct_score + preleuka_ALC_l,
    fitter = lrm,
    data = df,
    xtrans = mi,
    x=T,
    y=T
  )

#Response by PET only criteria
fit_mi_PET <-
  fit.mult.impute(
    bestCR_PET_b ~ product + preleuka_LDH_l + preleuka_bulk_s + age + hct_score + preleuka_ALC_l,
    fitter = lrm,
    data = df,
    xtrans = mi,
    x=T,
    y=T
  )

CR_t <- resp_table_sparser(fit_uni,fit_mi)
CR_CT_t <- resp_table_sparser(fit_uniCT,fit_mi_CT)
CR_PET_t <- resp_table_sparser(fit_uniPET,fit_mi_PET)
```

### Figure 3. Forest plot of predictors of complete response after CD19 CAR T-cell therapy

```{r,layout="l-body-outset",fig.width=10, fig.height=6}
newnames <- c("Preleukapheresis LDH", "Preleukapheresis largest lesion diameter", "Age", "HCT-CI", "Preleukapheresis ALC","tisacel versus axicel","JCAR014 versus axicel")
newhead <- c("Odds Ratio", "Lower CI", "Upper CI" )
forestplot(summary(fit_mi),digits=2,title="OR for complete response (best response by PET or CT)",row.names.y = newnames,header = newhead)

#Save as .eps
# cairo_ps("manuscript/Blood_resub2/Fig3.eps", width = 12, height = 4)
# newnames <- c("Preleukapheresis LDH", "Preleukapheresis largest lesion diameter", "Age", "HCT-CI", "Preleukapheresis ALC","tisacel versus axicel","JCAR014 versus axicel")
# newhead <- c("Odds Ratio", "Lower CI", "Upper CI" )
# p <- forestplot(summary(fit_mi),digits=2,title="OR for complete response (best response by PET or CT)",row.names.y = newnames,header = newhead)
# grid.arrange(p,top = grid::textGrob("Figure 3.", x = 0, hjust = 0,gp=grid::gpar(fontface="bold")))
# dev.off()

```


### Sensitivity analysis: univariate and multivariable logistic regression for CR (best response) excluding JCAR014

```{r,results='asis',layout="l-body-outset",fig.width=5, fig.height=5}
options(datadist='dd2')
#Univariate
fit_resp_sub <- lrm(bestCR_b ~ product,x=T,y=T,data=df2)
fit_resp_subCT <- lrm(bestCR_CT_b ~ product,x=T,y=T,data=df2)
fit_resp_subPET <- lrm(bestCR_PET_b ~ product,x=T,y=T,data=df2)
#Multivariable
fit_mi_sub <-
  fit.mult.impute(
    bestCR_b ~ product + preleuka_LDH_l + preleuka_bulk_s + age + hct_score + preleuka_ALC_l,
    fitter = lrm,
    data = df2,
    xtrans = mi2,
    x = T,
    y = T
  )
fit_mi_subCT <-
  fit.mult.impute(
    bestCR_CT_b ~ product + preleuka_LDH_l + preleuka_bulk_s + age + hct_score + preleuka_ALC_l,
    fitter = lrm,
    data = df2,
    xtrans = mi2,
    x = T,
    y = T
  )
fit_mi_subPET <-
  fit.mult.impute(
    bestCR_PET_b ~ product + preleuka_LDH_l + preleuka_bulk_s + age + hct_score + preleuka_ALC_l,
    fitter = lrm,
    data = df2,
    xtrans = mi2,
    x = T,
    y = T
  )

#Build table for resp PET or CT
#Parse ORs and 95% CIs from univariate model
d <- summary(fit_resp_sub)
d <- data.frame(d)
resp_unadj <- cbind(round(d[2,4],2),paste(round(d[2,6],2),round(d[2,7],2),sep="-"))
colnames(resp_unadj) <- c("unadjusted OR","95% CI")
rownames(resp_unadj) <- c("Tisacel versus axicel")
#Parse p values from univariate model
unadjstats_d <- get_model_stats(fit_resp_sub)
#Parse p values from multivariable model
adjstats_d <- get_model_stats(fit_mi_sub)
#Parse ORs and 95% CI from multivariable model
d <- data.frame(summary(fit_mi_sub))
resp_adj <- cbind(round(d[12,4],2),paste(round(d[12,6],2),round(d[12,7],2),sep="-"))
colnames(resp_adj) <- c("adjusted OR","95% CI")
rownames(resp_adj) <- c("Tisacel versus axicel")
#Create table object
CR_sub_t <- cbind(resp_unadj,unadjstats_d$coefs[2,5],resp_adj,adjstats_d$coefs[2,5])

#Build table for CR by CT only
#Parse ORs and 95% CIs from univariate model
d <- summary(fit_resp_subCT)
d <- data.frame(d)
resp_unadj <- cbind(round(d[2,4],2),paste(round(d[2,6],2),round(d[2,7],2),sep="-"))
colnames(resp_unadj) <- c("unadjusted OR","95% CI")
rownames(resp_unadj) <- c("Tisacel versus axicel")
#Parse p values from univariate model
unadjstats_d <- get_model_stats(fit_resp_subCT)
#Parse p values from multivariable model
adjstats_d <- get_model_stats(fit_mi_subCT)
#Parse ORs and 95% CI from multivariable model
d <- data.frame(summary(fit_mi_subCT))
resp_adj <- cbind(round(d[12,4],2),paste(round(d[12,6],2),round(d[12,7],2),sep="-"))
colnames(resp_adj) <- c("adjusted OR","95% CI")
rownames(resp_adj) <- c("Tisacel versus axicel")

CR_CT_sub_t <- cbind(resp_unadj,unadjstats_d$coefs[2,5],resp_adj,adjstats_d$coefs[2,5])

#Build table for CR by PET only
#Parse ORs and 95% CIs from univariate model
d <- summary(fit_resp_subPET)
d <- data.frame(d)
resp_unadj <- cbind(round(d[2,4],2),paste(round(d[2,6],2),round(d[2,7],2),sep="-"))
colnames(resp_unadj) <- c("unadjusted OR","95% CI")
rownames(resp_unadj) <- c("Tisacel versus axicel")
#Parse p values from univariate model
unadjstats_d <- get_model_stats(fit_resp_subPET)
#Parse p values from multivariable model
adjstats_d <- get_model_stats(fit_mi_subPET)
#Parse ORs and 95% CI from multivariable model
d <- data.frame(summary(fit_mi_subPET))
resp_adj <- cbind(round(d[12,4],2),paste(round(d[12,6],2),round(d[12,7],2),sep="-"))
colnames(resp_adj) <- c("adjusted OR","95% CI")
rownames(resp_adj) <- c("Tisacel versus axicel")

CR_PET_sub_t <- cbind(resp_unadj,unadjstats_d$coefs[2,5],resp_adj,adjstats_d$coefs[2,5])
```

### Sensitivity analysis: univariate and multivariable logistic regression for CR (best response) including bridging therapy

```{r}
options(datadist='dd')
#Univariate
fit_resp <- lrm(bestCR_b ~ product,x=T,y=T,data=df)
fit_resp_CT <- lrm(bestCR_CT_b ~ product,x=T,y=T,data=df)
fit_resp_PET <- lrm(bestCR_PET_b ~ product,x=T,y=T,data=df)
#Multivariate
fit_mi <-
  fit.mult.impute(
    bestCR_b ~ product + preleuka_LDH_l + preleuka_bulk_s + age + hct_score + preleuka_ALC_l + bridge,
    fitter = lrm,
    data = df,
    xtrans = mi,
    x=T,
    y=T
  )
fit_mi_CT <-
  fit.mult.impute(
    bestCR_CT_b ~ product + preleuka_LDH_l + preleuka_bulk_s + age + hct_score + preleuka_ALC_l + bridge,
    fitter = lrm,
    data = df,
    xtrans = mi,
    x=T,
    y=T
  )
fit_mi_PET <-
  fit.mult.impute(
    bestCR_PET_b ~ product + preleuka_LDH_l + preleuka_bulk_s + age + hct_score + preleuka_ALC_l + bridge,
    fitter = lrm,
    data = df,
    xtrans = mi,
    x=T,
    y=T
  )
resp_bridge_t <- resp_table_sparser(fit_resp,fit_mi)
respCT_bridge_t <- resp_table_sparser(fit_resp_CT,fit_mi_CT)
respPET_bridge_t <- resp_table_sparser(fit_resp_PET,fit_mi_PET)
```

### Sensitivity analysis: univariate and multivariable logistic regression for CR (best response) including preLD ALC instead of preleukapheresis ALC

```{r}
options(datadist='dd')
#Univariate
fit_resp <- lrm(bestCR_b ~ product,x=T,y=T,data=df)
fit_resp_CT <- lrm(bestCR_CT_b ~ product,x=T,y=T,data=df)
fit_resp_PET <- lrm(bestCR_PET_b ~ product,x=T,y=T,data=df)
#Multivariate
fit_mi <-
  fit.mult.impute(
    bestCR_b ~ product + preleuka_LDH_l + preleuka_bulk_s + age + hct_score + preLD_ALC_l + bridge,
    fitter = lrm,
    data = df,
    xtrans = mi,
    x=T,
    y=T
  )
fit_mi_CT <-
  fit.mult.impute(
    bestCR_CT_b ~ product + preleuka_LDH_l + preleuka_bulk_s + age + hct_score + preLD_ALC_l + bridge,
    fitter = lrm,
    data = df,
    xtrans = mi,
    x=T,
    y=T
  )
fit_mi_PET <-
  fit.mult.impute(
    bestCR_PET_b ~ product + preleuka_LDH_l + preleuka_bulk_s + age + hct_score + preLD_ALC_l + bridge,
    fitter = lrm,
    data = df,
    xtrans = mi,
    x=T,
    y=T
  )
resp_preLDALC_t <- resp_table_sparser(fit_resp,fit_mi)
respCT_preLDALC_t <- resp_table_sparser(fit_resp_CT,fit_mi_CT)
respPET_preLDALC_t <- resp_table_sparser(fit_resp_PET,fit_mi_PET)
```

### Sensitivity analysis: univariate and multivariable logistic regression model for ORR (best response - CT criteria only)

```{r}
options(datadist='dd')
fit_uni <-
  fit.mult.impute(
    bestresp_CT_b ~ product,
    fitter = lrm,
    data = df,
    xtrans = mi,
    x=T,
    y=T
  )
print(fit_uni)
fit_mi <-
  fit.mult.impute(
    bestresp_CT_b ~ product + preleuka_LDH_l + preleuka_bulk_s + age + hct_score + preleuka_ALC_l,
    fitter = lrm,
    data = df,
    xtrans = mi,
    x=T,
    y=T
  )
options(prType="html")
print(
  fit_mi,
  digits = 2,
  coefs = T,
  title = "Multivariable ordinal proportional odds logistic regression model for CR (best response - CT criteria only)"
)
print(summary(fit_mi,age=c(50,60),preleuka_LDH_l=c(2,2.3),preleuka_bulk_s=c(1,2),preleuka_ALC_l=c(2,2.3)),digits = 2)
print(anova(fit_mi),digits = 2)
options(prType=NULL)

ORR_CT_t <- resp_table_sparser(fit_uni,fit_mi)
ORR_CT_t
```

### Sensitivity analysis: univariate and multivariable logistic regression model for ORR (best response - PET criteria only)

```{r}
options(datadist='dd')
fit <-
  fit.mult.impute(
    bestresp_PET_b ~ product,
    fitter = lrm,
    data = df,
    xtrans = mi,
    x=T,
    y=T
  )
print(fit)
fit_mi <-
  fit.mult.impute(
    bestresp_PET_b ~ product + preleuka_LDH_l + preleuka_bulk_s + age + hct_score + preleuka_ALC_l,
    fitter = lrm,
    data = df,
    xtrans = mi,
    x=T,
    y=T
  )
options(prType="html")
print(
  fit_mi,
  digits = 2,
  coefs = T,
  title = "Multivariable ordinal proportional odds logistic regression model for CR (best response - PET criteria only)"
)
print(summary(fit_mi,age=c(50,60),preleuka_LDH_l=c(2,2.3),preleuka_bulk_s=c(1,2),preleuka_ALC_l=c(2,2.3)),digits = 2)
print(anova(fit_mi),digits = 2)
options(prType=NULL)

ORR_PET_t <- resp_table_sparser(fit_uni,fit_mi)
ORR_PET_t

```

### Table 3. CAR T-cell product type and outcome prediction

```{r t3}
rbind(CRS_t, NT_t, CR_t, CR_CT_t, CR_PET_t) %>%
  addHtmlTableStyle(pos.caption = "bottom") %>%
  htmlTable(
    rgroup = c(
      "CRS grade*",
      "ICANS grade*",
      "CR (Best Response)^",
      "CR (Best Response - CT criteria only)^",
      "CR (Best Response - PET criteria only)^"
    ),
    n.rgroup = c(2, 2, 2, 2, 2),
    caption = "*From a multivariable proportional odds logistic regression model or ^logistic regression model including the following variables: CAR T-cell product type, preleukapheresis LDH, preleukapheresis largest lesion diameter, age, HCT-CI, preleukapheresis ALC. P values per the Wald test."
  )
```

### Table S4. Comparison of preleukapheresis and prelymphodepletion tumor burden and ALC

```{r}

#Descriptive statistics
df %>%
  select(patient_id,
         `Preleukapheresis` = preleuka_LDH,
         `Prelymphodepletion` = preLD_LDH) %>%
  pivot_longer(
    cols = c(`Preleukapheresis`, `Prelymphodepletion`),
    names_to = "TP",
    values_to = "LDH"
  ) %>%
  left_join(
    .,
    df %>%
      select(
        patient_id,
        `Preleukapheresis` = preleuka_bulk_s,
        `Prelymphodepletion` = preLD_bulk_s
      ) %>%
      pivot_longer(
        cols = c(`Preleukapheresis`, `Prelymphodepletion`),
        names_to = "TP",
        values_to = "Largest lesion diameter"
      ),
    by=c("patient_id","TP")) %>%
  left_join(
    .,
    df %>%
      select(
        patient_id,
        `Preleukapheresis` = preleuka_ALC,
        `Prelymphodepletion` = preLD_ALC
      ) %>%
      pivot_longer(
        cols = c(`Preleukapheresis`, `Prelymphodepletion`),
        names_to = "TP",
        values_to = "ALC"
      ),
    by=c("patient_id","TP")) %>% 
  select(-patient_id) %>% 
  tbl_summary(
    by="TP",
    type = all_continuous() ~ "continuous2",
    statistic = all_continuous() ~ c("{median} ({p25}, {p75})", 
                                     "{min}, {max}"),
    missing_text = "Missing data",
    sort = all_categorical() ~ "frequency") %>%
  add_p(all_continuous() ~ "wilcox.test",
             simulate.p.value=TRUE) %>% 
  bold_labels() 
```

### Table S5. Sensitivity analysis including bridging therapy in addition to the minimal adjustment set of covariates

```{r tS4}
rbind(CRS_bridge_t,
      NT_bridge_t,
      resp_bridge_t,
      respCT_bridge_t,
      respPET_bridge_t) %>%
  addHtmlTableStyle(pos.caption = "bottom") %>%
  htmlTable(
    rgroup = c("CRS grade*", "ICANS grade*", "CR (Best Response)^","CR (Best Response - CT criteria only)^","CR (Best Response - PET criteria only)^"),
    n.rgroup = c(2, 2, 2, 2, 2),
    caption = "*From a multivariable proportional odds logistic regression model or ^logistic regression model including the following variables: CAR T-cell product type, preleukapheresis LDH, preleukapheresis largest lesion diameter, age, HCT-CI, preleukapheresis ALC, bridging therapy post leukapheresis. P values per the Wald test."
  )
```

### Table S6. Sensitivity analysis excluding JCAR014 patients

```{r}
rbind(CRS_sub_t, NT_sub_t, CR_sub_t, CR_CT_sub_t, CR_PET_sub_t) %>%
  addHtmlTableStyle(pos.caption = "bottom") %>%
  htmlTable(
    rgroup = c(
      "CRS grade*",
      "ICANS grade*",
      "CR (Best Response)^",
      "CR (Best Response - CT criteria only)^",
      "CR (Best Response - PET criteria only)^"
    ),
    n.rgroup = c(1, 1, 1, 1, 1),
    caption = "*From a multivariable proportional odds logistic regression model or ^logistic regression model including the following variables: CAR T-cell product type, preleukapheresis LDH, preleukapheresis largest lesion diameter, age, HCT-CI, preleukapheresis ALC, bridging therapy post leukapheresis. P values per the Wald test."
  )

```

### Table S7. Sensitivity analysis including prelymphodepletion ALC instead of preleukapheresis ALC

```{r}
rbind(CRS_preLDALC_t,
      NT_preLDALC_t,
      resp_preLDALC_t,
      respCT_preLDALC_t,
      respPET_preLDALC_t) %>%
  addHtmlTableStyle(pos.caption = "bottom") %>%
  htmlTable(
    rgroup = c(
      "CRS grade*",
      "ICANS grade*",
      "CR (Best Response)^",
      "CR (Best Response - CT criteria only)^",
      "CR (Best Response - PET criteria only)^"
    ),
    n.rgroup = c(2, 2, 2, 2, 2),
    caption = "*From a multivariable proportional odds logistic regression model or ^logistic regression model including the following variables: CAR T-cell product type, preleukapheresis LDH, preleukapheresis largest lesion diameter, age, HCT-CI, prelymphodepletion ALC, bridging therapy post leukapheresis. P values per the Wald test."
  )
```
### Multivariable ordinal logistic regression model for CRS grade including interaction effects

```{r effmodCRS,results='asis',layout="l-body-outset",fig.width=8, fig.height=6}
#Merge tisacel and JCAR014
df <- df %>% 
  mutate(product_s=ifelse(product=="axicel","axicel","tisacel/JCAR014"))
dd <- datadist(df)
options(datadist='dd')

#### Refit model for CRS with interaction terms
fit_mi <-
  fit.mult.impute(
    crs_g_r ~ product_s*preleuka_LDH_l + product_s*preleuka_bulk_s + product_s*age + product_s*hct_score + product_s*preleuka_ALC_l,
    fitter = lrm,
    data = df,
    xtrans = mi,
    x=T,
    y=T
  )
options(prType="html")
print(
  fit_mi,
  digits = 2,
  coefs = T
)
print(anova(fit_mi))
plot(anova(fit_mi))
fit_check_ord2(fit_mi)
options(prType=NULL)
```

### Multivariable ordinal logistic regression model for ICANS grade including interaction terms

```{r effmodICANS,results='asis',fig.width=12, fig.height=6}
fit_mi <-
  fit.mult.impute(
    nt_g_r ~ product_s*preleuka_LDH_l + product_s*preleuka_bulk_s + product_s*age + product_s*hct_score + product_s*preleuka_ALC_l,
    fitter = lrm,
    data = df,
    xtrans = mi,
    x=TRUE,y=TRUE
  )
options(prType="html")
print(
  fit_mi,
  digits = 2,
  coefs = T
)
print(anova(fit_mi))
plot(anova(fit_mi))
fit_check_ord3(fit_mi)
options(prType=NULL)
```

## Multivariable logistic regression model for CR including interaction terms

```{r effmodCR,layout="l-body-outset",fig.width=8, fig.height=8}
fit_mi <-
  fit.mult.impute(
    bestCR_b ~ product_s * preleuka_ALC_l + product_s * preleuka_bulk_s + product_s *
      age + product_s * hct_score + product_s * preleuka_LDH_l,
    fitter = lrm,
    data = df,
    xtrans = mi,
    x=T,y=T
  )
options(prType="html")
print(
  fit_mi,
  digits = 2,
  coefs = T
)
# options(prType=NULL)
print(anova(fit_mi))
plot(anova(fit_mi))
plot(calibrate(fit_mi))
options(prType=NULL)
```

## Figure 4. The efficacy of distinct CAR T-cell products is differentially impacted by preleukapheresis ALC

```{r,layout="l-body-outset",fig.width=10, fig.height=8}
alc_breaks <- round(c(10^-.5,10^-.25,10^0,10^.25),2)
data.frame(Predict(fit_mi,preleuka_ALC_l,product_s,fun = plogis)) %>%
  mutate(product_s=recode(product_s,`axicel`="axicel",`tisacel/jcar014`="tisacel/JCAR014")) %>% 
  ggplot() +
  geom_line(aes(x=preleuka_ALC_l,y=yhat,col=product_s)) +
  geom_ribbon(aes(x=preleuka_ALC_l,ymin=lower, ymax=upper,fill=product_s),alpha=0.10)+
  labs(x = "Preleukapheresis ALC (G/L)",
       y = "Probability of CR")+
  scale_x_continuous(labels = alc_breaks,breaks = c(-.5,-.25,0,.25))+
  ggtitle("Figure 4.")+
  theme_bw() +
  theme(title = element_text(size=16,face="bold"),legend.title=element_blank())

# Save to eps
# cairo_ps("Manuscript/Fig 4.eps", width = 9, height = 8)
# data.frame(Predict(fit_mi,preleuka_ALC_l,product_s,fun = plogis)) %>%
#   mutate(product_s=recode(product_s,`axicel`="axicel",`tisacel/jcar014`="tisacel/JCAR014")) %>% 
#   ggplot() +
#   geom_line(aes(x=preleuka_ALC_l,y=yhat,col=product_s)) +
#   geom_ribbon(aes(x=preleuka_ALC_l,ymin=lower, ymax=upper,fill=product_s),alpha=0.10)+
#   labs(x = "Preleukapheresis ALC (G/L)",
#        y = "Probability of CR")+
#   scale_x_continuous(labels = alc_breaks,breaks = c(-.5,-.25,0,.25))+
#   ggtitle("Figure 4.")+
#   theme_bw() +
#   theme(plot.title = element_text(size=16,face="bold"),legend.title=element_blank())
# dev.off()

```

## Computational environment

```{r}
devtools::session_info()
```

